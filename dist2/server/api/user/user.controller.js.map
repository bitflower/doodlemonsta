{"version":3,"sources":["api/user/user.controller.js"],"names":[],"mappings":"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","file":"api/user/user.controller.js","sourcesContent":["'use strict';\n\nvar mongoose = require('bluebird').promisifyAll(require('mongoose'));\n\nimport User from './user.model';\nimport Monsta from '../monsta/monsta.model';\n\nimport passport from 'passport';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\n\nfunction validationError(res, statusCode) {\n    statusCode = statusCode || 422;\n    return function(err) {\n        res.status(statusCode).json(err);\n    }\n}\n\nfunction handleError(res, statusCode) {\n    statusCode = statusCode || 500;\n    return function(err) {\n        res.status(statusCode).send(err);\n    };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n    User.findAsync({}, '-salt -password')\n        .then(users => {\n            res.status(200).json(users);\n        })\n        .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res, next) {\n\n    // Create new user object\n    var newUser = new User(req.body);\n\n    User.find({\n        name: newUser.name\n    }, '-salt -hashedPassword', function(err, users) {\n        if (err) return res.send(500, err);\n\n        if (users && users.length > 0) {\n            res.json(409, {\n                err: 'USERNAME_TAKEN',\n                message: 'Username already taken'\n            });\n        }\n    });\n\n    newUser.provider = 'local';\n    newUser.role = 'user';\n    newUser.saveAsync()\n        .spread(function(user) {\n            var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n                expiresIn: 60 * 60 * 5\n            });\n            res.json({ token });\n        })\n        .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n    var userId = req.params.id;\n\n    User.findByIdAsync(userId)\n        .then(user => {\n            if (!user) {\n                return res.status(404).end();\n            }\n            res.json(user.profile);\n        })\n        .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n    User.findByIdAndRemoveAsync(req.params.id)\n        .then(function() {\n            res.status(204).end();\n        })\n        .catch(handleError(res));\n}\n\n/**\n * Change a users password\n */\nexport function changePassword(req, res, next) {\n    var userId = req.user._id;\n    var oldPass = String(req.body.oldPassword);\n    var newPass = String(req.body.newPassword);\n\n    User.findByIdAsync(userId)\n        .then(user => {\n            if (user.authenticate(oldPass)) {\n                user.password = newPass;\n                return user.saveAsync()\n                    .then(() => {\n                        res.status(204).end();\n                    })\n                    .catch(validationError(res));\n            } else {\n                return res.status(403).end();\n            }\n        });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n    var userId = req.user._id;\n\n    User.findOneAsync({ _id: userId }, '-salt -password')\n        .then(user => { // don't ever give out the password or salt\n            if (!user) {\n                return res.status(401).end();\n            }\n            res.json(user);\n        })\n        .catch(err => next(err));\n}\n\n/**\n * Search a user by username\n */\nexport function search(req, res, next) {\n\n    var username = req.params.username;\n\n    User.findOneAsync({\n            name: username\n        })\n        .then(user => {\n            if (!user) {\n                return res.status(404).end();\n            }\n            res.json(user.profile);\n        })\n        .catch(err => next(err));\n}\n\n/**\n * Get pending monsters of user\n */\nexport function pendingMonstas(req, res, next) {\n    var userId = mongoose.Types.ObjectId(req.params.id);\n\n    console.log('userId', userId);\n\n    Monsta\n        .findAsync({\n            'head.user': userId\n        })\n        // .select({ name: 1, head: 0, stomach: 0 })\n        .then(monstas => { // don't ever give out the password or salt\n            if (!monstas) {\n                return res.status(401).end();\n            }\n            res.json(monstas.length);\n        })\n        .catch(err => next(err));\n\n    // User\n    //     .findOneAsync({ _id: userId }, '-salt -password')\n    //     .then(user => { // don't ever give out the password or salt\n    //         if (!user) {\n    //             return res.status(401).end();\n    //         }\n    //         res.json(user);\n    //     })\n    //     .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexport function authCallback(req, res, next) {\n    res.redirect('/');\n}\n"],"sourceRoot":"/source/"}